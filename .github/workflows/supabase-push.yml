name: Deploy Supabase (db push)

on:
  workflow_dispatch:
  push:
    paths:
      - "supabase/**"
      - ".supabase/**"
      - "db/migrations/**"
      - "sql/**"

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Verify Supabase CLI via npx
        run: npx --yes supabase@latest --version

      - name: Debug show config/state
        run: |
          echo "PWD:"; pwd
          echo
          echo "Root listing:"; ls -la
          echo
          echo "supabase/ listing:"; ls -la supabase || true
          echo
          echo "Show supabase/config.toml:"; cat supabase/config.toml || true
          echo
          echo ".supabase listing:"; ls -la .supabase || true
          echo
          echo "Show .supabase/project:"; cat .supabase/project || true

      - name: Authenticate and link (skip when secret missing or folder absent)
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
        run: |
          set -euo pipefail
          if [ -z "${SUPABASE_ACCESS_TOKEN:-}" ]; then
            echo "SUPABASE_ACCESS_TOKEN not set; skipping Supabase db push"
            exit 0
          fi

          if [ ! -d "supabase" ]; then
            echo "No supabase/ directory; skipping Supabase db push"
            exit 0
          fi

          npx --yes supabase@latest login --token "$SUPABASE_ACCESS_TOKEN"
          npx --yes supabase@latest link --project-ref "jskajkwulaaakhaolzdu" --debug

      - name: Push CLI-managed migrations (cwd: supabase)
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
        working-directory: supabase
        run: |
          set -euo pipefail
          if [ -z "${SUPABASE_ACCESS_TOKEN:-}" ]; then
            echo "SUPABASE_ACCESS_TOKEN not set; skipping"
            exit 0
          fi

          npx --yes supabase@latest db push --project-ref "jskajkwulaaakhaolzdu" --debug
