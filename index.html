<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Company KPI Dashboard</title>
  <!-- Tailwind via CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-50">
  <div id="root"></div>

  <!-- React & ReactDOM UMD -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

  <!-- Recharts UMD (requires d3-scale, etc.) -->
  <script src="https://unpkg.com/d3-array@3"></script>
  <script src="https://unpkg.com/d3-color@3"></script>
  <script src="https://unpkg.com/d3-format@3"></script>
  <script src="https://unpkg.com/d3-interpolate@3"></script>
  <script src="https://unpkg.com/d3-scale@4"></script>
  <script src="https://unpkg.com/d3-shape@3"></script>
  <script src="https://unpkg.com/d3-time@3"></script>
  <script src="https://unpkg.com/d3-time-format@4"></script>
  <script src="https://unpkg.com/recharts/umd/Recharts.js"></script>

  <script>
    const { useState, useEffect, useMemo, useRef } = React;
    const {
      LineChart, Line, XAxis, YAxis, Tooltip, ResponsiveContainer,
      AreaChart, Area, BarChart, Bar, Legend, CartesianGrid
    } = Recharts;

    const sampleHistory = [
      { month: "Jan", grossMargin: 0.43, ebitdaPct: 0.11, sgaPct: 0.22, workingCapital: 180000 },
      { month: "Feb", grossMargin: 0.46, ebitdaPct: 0.12, sgaPct: 0.215, workingCapital: 192000 },
      { month: "Mar", grossMargin: 0.47, ebitdaPct: 0.135, sgaPct: 0.21, workingCapital: 205000 },
      { month: "Apr", grossMargin: 0.49, ebitdaPct: 0.14, sgaPct: 0.205, workingCapital: 212000 },
      { month: "May", grossMargin: 0.51, ebitdaPct: 0.16, sgaPct: 0.20, workingCapital: 219000 },
      { month: "Jun", grossMargin: 0.52, ebitdaPct: 0.165, sgaPct: 0.198, workingCapital: 225000 },
      { month: "Jul", grossMargin: 0.50, ebitdaPct: 0.155, sgaPct: 0.205, workingCapital: 221000 },
      { month: "Aug", grossMargin: 0.53, ebitdaPct: 0.17, sgaPct: 0.197, workingCapital: 231500 },
      { month: "Sep", grossMargin: 0.545, ebitdaPct: 0.175, sgaPct: 0.195, workingCapital: 238000 },
    ];

    const sampleKpis = {
      revenue: 1650000,
      headcount: 21,
      revenuePerEmployee: 1650000 / 21,
      newCustomers: 42,
      salesMktgSpend: 98000,
      cac: 98000 / 42,
      currentAssets: 620000,
      currentLiabilities: 380000,
      workingCapital: 620000 - 380000,
      grossMargin: 0.545,
      sgaPct: 0.195,
      ebitdaPct: 0.175,
      trainingPct: 0.015,
      poorQualityPct: 0.022,
    };

    const defaultTargets = {
      grossMargin: 0.5,
      ebitdaPct: 0.18,
      sgaPct: 0.2,
      revenuePerEmployee: 120000,
      cac: 2500,
      workingCapital: 200000,
      trainingPct: 0.02,
      poorQualityPct: 0.015,
    };

    const STORAGE_KEY = "kpiDashboardState:v1";

    function formatPct(n) {
      if (n == null || isNaN(n)) return "—";
      return (n * 100).toFixed(1) + "%";
    }

    function formatMoney(n) {
      if (n == null || isNaN(n)) return "—";
      return n.toLocaleString(undefined, { style: "currency", currency: "USD", maximumFractionDigits: 0 });
    }

    function Delta({ value, target, invert }) {
      if (value == null || target == null) return null;
      const diff = invert ? target - value : value - target;
      const good = diff >= 0;
      const badge = good ? "bg-emerald-100 text-emerald-700" : "bg-rose-100 text-rose-700";
      const sign = good ? "+" : "";
      const isPct = typeof value === "number" && typeof target === "number" && value <= 1 && target <= 1;
      const fmt = isPct ? (diff * 100).toFixed(1) + "pp" : formatMoney(diff);
      return React.createElement("span", { className: "ml-2 inline-flex items-center rounded-full px-2 py-0.5 text-xs font-medium " + badge }, sign + fmt);
    }

    function KpiCard({ title, value, target, invert, formatter, children }) {
      const isGood = (function(){
        if (value == null || target == null) return null;
        return invert ? value <= target : value >= target;
      })();

      return React.createElement("div", { className: "rounded-2xl border bg-white p-4 shadow-sm" },
        React.createElement("div", { className: "flex items-start justify-between" },
          React.createElement("div", null,
            React.createElement("h3", { className: "text-sm font-semibold text-slate-600" }, title),
            React.createElement("div", { className: "mt-2 flex items-center" },
              React.createElement("div", { className: "text-2xl font-bold text-slate-900" }, formatter ? formatter(value) : value),
              target != null && React.createElement("span", { className: "ml-3 text-xs text-slate-500" }, "Target: ", formatter ? formatter(target) : target),
              target != null && value != null && React.createElement(Delta, { value, target, invert })
            )
          ),
          isGood != null && React.createElement("div", { className: "ml-4 rounded-full px-3 py-1 text-xs font-medium " + (isGood ? "bg-emerald-100 text-emerald-700" : "bg-rose-100 text-rose-700") }, isGood ? "On Track" : "Needs Attention")
        ),
        children && React.createElement("div", { className: "mt-4" }, children)
      );
    }

    function App() {
      const [kpiTargets, setKpiTargets] = useState(defaultTargets);
      const [kpi, setKpi] = useState(sampleKpis);
      const [history, setHistory] = useState(sampleHistory);
      const [autoLoad, setAutoLoad] = useState(true);
      const fileInputRef = useRef(null);

      // allow query param overrides (?data=<base64-encoded json>)
      useEffect(() => {
        const url = new URL(window.location.href);
        const dataParam = url.searchParams.get("data");
        if (dataParam) {
          try {
            const json = JSON.parse(atob(dataParam));
            if (json.kpi) setKpi(json.kpi);
            if (json.kpiTargets) setKpiTargets(json.kpiTargets);
            if (json.history) setHistory(json.history);
          } catch {}
        }
      }, []);

      const saveState = () => {
        const payload = { kpi, kpiTargets, history, savedAt: new Date().toISOString() };
        localStorage.setItem(STORAGE_KEY, JSON.stringify(payload));
        alert("Saved locally.");
      };
      const loadState = () => {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return alert("No saved data found.");
        try {
          const parsed = JSON.parse(raw);
          if (parsed.kpi) setKpi(parsed.kpi);
          if (parsed.kpiTargets) setKpiTargets(parsed.kpiTargets);
          if (parsed.history) setHistory(parsed.history);
          alert("Loaded saved data.");
        } catch (e) {
          alert("Could not load saved data.");
        }
      };
      const resetDefaults = () => {
        if (!confirm("Reset to defaults? This will not delete your saved copy.")) return;
        setKpi({...sampleKpis});
        setKpiTargets({...defaultTargets});
        setHistory([...sampleHistory]);
      };
      const exportJson = () => {
        const payload = { kpi, kpiTargets, history };
        const blob = new Blob([JSON.stringify(payload, null, 2)], { type: "application/json" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "kpi-dashboard-data.json";
        a.click();
        URL.revokeObjectURL(url);
      };
      const onImportFile = (e) => {
        const f = e.target.files?.[0];
        if (!f) return;
        const reader = new FileReader();
        reader.onload = () => {
          try {
            const parsed = JSON.parse(reader.result);
            if (parsed.kpi) setKpi(parsed.kpi);
            if (parsed.kpiTargets) setKpiTargets(parsed.kpiTargets);
            if (parsed.history) setHistory(parsed.history);
            alert("Imported JSON.");
          } catch (err) {
            alert("Invalid JSON file.");
          } finally {
            e.target.value = "";
          }
        };
        reader.readAsText(f);
      };

      useEffect(() => {
        if (!autoLoad) return;
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return;
        try {
          const parsed = JSON.parse(raw);
          if (parsed.kpi) setKpi(parsed.kpi);
          if (parsed.kpiTargets) setKpiTargets(parsed.kpiTargets);
          if (parsed.history) setHistory(parsed.history);
        } catch {}
      }, [autoLoad]);

      const revPerEmpSeries = useMemo(
        () => history.map(d => ({ month: d.month, value: kpi.revenuePerEmployee })),
        [history, kpi.revenuePerEmployee]
      );
      const marginSeries = useMemo(() => history.map(d => ({ month: d.month, value: d.grossMargin })), [history]);
      const ebitdaSeries = useMemo(() => history.map(d => ({ month: d.month, value: d.ebitdaPct })), [history]);
      const sgaSeries = useMemo(() => history.map(d => ({ month: d.month, value: d.sgaPct })), [history]);

      // helper for URL with embedded data
      const linkWithData = () => {
        const payload = { kpi, kpiTargets, history };
        const b64 = btoa(JSON.stringify(payload));
        const u = new URL(window.location.href);
        u.searchParams.set("data", b64);
        return u.toString();
      };

      return React.createElement("div", { className: "min-h-screen bg-slate-50" },
        // Header
        React.createElement("header", { className: "sticky top-0 z-10 border-b bg-white/90 backdrop-blur" },
          React.createElement("div", { className: "mx-auto flex max-w-7xl items-center justify-between px-4 py-3" },
            React.createElement("div", { className: "flex items-center gap-3" },
              React.createElement("div", { className: "h-9 w-9 rounded-2xl bg-slate-900" }),
              React.createElement("h1", { className: "text-lg font-semibold text-slate-900" }, "Company KPI Dashboard")
            ),
            React.createElement("div", { className: "flex items-center gap-2" },
              React.createElement("button", { onClick: saveState, className: "rounded-xl border px-3 py-2 text-sm hover:bg-slate-50" }, "Save"),
              React.createElement("button", { onClick: loadState, className: "rounded-xl border px-3 py-2 text-sm hover:bg-slate-50" }, "Load"),
              React.createElement("button", { onClick: resetDefaults, className: "rounded-xl border px-3 py-2 text-sm hover:bg-slate-50" }, "Reset"),
              React.createElement("button", { onClick: exportJson, className: "rounded-xl border px-3 py-2 text-sm hover:bg-slate-50" }, "Export JSON"),
              React.createElement("input", { ref: (el)=> fileInputRef.current=el, type: "file", accept: "application/json", onChange: onImportFile, className: "hidden" }),
              React.createElement("button", { onClick: ()=> fileInputRef.current && fileInputRef.current.click(), className: "rounded-xl border px-3 py-2 text-sm hover:bg-slate-50" }, "Import JSON"),
              React.createElement("label", { className: "ml-2 inline-flex items-center gap-2 text-xs text-slate-600" },
                React.createElement("input", { type: "checkbox", checked: autoLoad, onChange: (e)=> setAutoLoad(e.target.checked) }),
                "Auto-load saved data"
              ),
              React.createElement("a", { href: linkWithData(), target: "_blank", rel: "noreferrer", className: "ml-2 rounded-xl bg-slate-900 px-3 py-2 text-sm font-semibold text-white hover:bg-slate-800" }, "Share Link")
            )
          )
        ),

        // KPI Grid
        React.createElement("main", { className: "mx-auto max-w-7xl px-4 py-6" },
          React.createElement("section", { className: "grid gap-4 sm:grid-cols-2 lg:grid-cols-3" },
            React.createElement(KpiCard, { title: "Gross Margin %", value: kpi.grossMargin, target: kpiTargets.grossMargin, formatter: formatPct },
              React.createElement("div", { className: "h-24" },
                React.createElement(ResponsiveContainer, { width: "100%", height: "100%" },
                  React.createElement(AreaChart, { data: marginSeries },
                    React.createElement(XAxis, { dataKey: "month", tick: { fontSize: 12 } }),
                    React.createElement(YAxis, { hide: true, domain: [0,1] }),
                    React.createElement(Tooltip, { formatter: (v)=> formatPct(v) }),
                    React.createElement(Area, { type: "monotone", dataKey: "value", fillOpacity: 0.15, strokeWidth: 2 })
                  )
                )
              )
            ),
            React.createElement(KpiCard, { title: "EBITDA %", value: kpi.ebitdaPct, target: kpiTargets.ebitdaPct, formatter: formatPct },
              React.createElement("div", { className: "h-24" },
                React.createElement(ResponsiveContainer, { width: "100%", height: "100%" },
                  React.createElement(LineChart, { data: ebitdaSeries },
                    React.createElement(XAxis, { dataKey: "month", tick: { fontSize: 12 } }),
                    React.createElement(YAxis, { hide: true, domain: [0,1] }),
                    React.createElement(Tooltip, { formatter: (v)=> formatPct(v) }),
                    React.createElement(Line, { type: "monotone", dataKey: "value", strokeWidth: 2, dot: false })
                  )
                )
              )
            ),
            React.createElement(KpiCard, { title: "SG&A % of Revenue", value: kpi.sgaPct, target: kpiTargets.sgaPct, formatter: formatPct, invert: true },
              React.createElement("div", { className: "h-24" },
                React.createElement(ResponsiveContainer, { width: "100%", height: "100%" },
                  React.createElement(LineChart, { data: sgaSeries },
                    React.createElement(XAxis, { dataKey: "month", tick: { fontSize: 12 } }),
                    React.createElement(YAxis, { hide: true, domain: [0,1] }),
                    React.createElement(Tooltip, { formatter: (v)=> formatPct(v) }),
                    React.createElement(Line, { type: "monotone", dataKey: "value", strokeWidth: 2, dot: false })
                  )
                )
              )
            ),
            React.createElement(KpiCard, { title: "Revenue per Employee", value: kpi.revenuePerEmployee, target: kpiTargets.revenuePerEmployee, formatter: formatMoney },
              React.createElement("div", { className: "h-24" },
                React.createElement(ResponsiveContainer, { width: "100%", height: "100%" },
                  React.createElement(BarChart, { data: revPerEmpSeries },
                    React.createElement(XAxis, { dataKey: "month", tick: { fontSize: 12 } }),
                    React.createElement(YAxis, { hide: true }),
                    React.createElement(Tooltip, { formatter: (v)=> formatMoney(v) }),
                    React.createElement(Bar, { dataKey: "value" })
                  )
                )
              )
            ),
            React.createElement(KpiCard, { title: "Customer Acquisition Cost (CAC)", value: kpi.cac, target: kpiTargets.cac, formatter: formatMoney, invert: true },
              React.createElement("p", { className: "mt-2 text-xs text-slate-500" }, "Lower is better. Confirm you’re counting only Sales + Marketing spend divided by ", React.createElement("em", null, "new"), " customers in period.")
            ),
            React.createElement(KpiCard, { title: "Working Capital", value: kpi.workingCapital, target: kpiTargets.workingCapital, formatter: formatMoney },
              React.createElement("p", { className: "mt-2 text-xs text-slate-500" }, "Current Assets – Current Liabilities. Watch AR aging and inventory turns.")
            ),
            React.createElement(KpiCard, { title: "Training & Development % of Rev", value: kpi.trainingPct, target: kpiTargets.trainingPct, formatter: formatPct },
              React.createElement("p", { className: "mt-2 text-xs text-slate-500" }, "Keep investment aligned with values and growth objectives.")
            ),
            React.createElement(KpiCard, { title: "Cost of Poor Quality % of Rev", value: kpi.poorQualityPct, target: kpiTargets.poorQualityPct, formatter: formatPct, invert: true },
              React.createElement("p", { className: "mt-2 text-xs text-slate-500" }, "Track rework, returns, warranty claims, scrap, and complaints.")
            )
          ),

          // Trends
          React.createElement("section", { className: "mt-8 grid gap-4 lg:grid-cols-2" },
            React.createElement("div", { className: "rounded-2xl border bg-white p-4 shadow-sm" },
              React.createElement("div", { className: "flex items-center justify-between" },
                React.createElement("h3", { className: "text-sm font-semibold text-slate-700" }, "Profitability Trend"),
                React.createElement("span", { className: "text-xs text-slate-500" }, "Gross Margin vs EBITDA")
              ),
              React.createElement("div", { className: "mt-2 h-64" },
                React.createElement(ResponsiveContainer, { width: "100%", height: "100%" },
                  React.createElement(LineChart, { data: history },
                    React.createElement(CartesianGrid, { strokeDasharray: "3 3" }),
                    React.createElement(XAxis, { dataKey: "month" }),
                    React.createElement(YAxis, { domain: [0,1] }),
                    React.createElement(Tooltip, { formatter: (v)=> formatPct(v) }),
                    React.createElement(Legend, null),
                    React.createElement(Line, { type: "monotone", dataKey: "grossMargin", name: "Gross Margin %", strokeWidth: 2, dot: false }),
                    React.createElement(Line, { type: "monotone", dataKey: "ebitdaPct", name: "EBITDA %", strokeWidth: 2, dot: false })
                  )
                )
              )
            ),
            React.createElement("div", { className: "rounded-2xl border bg-white p-4 shadow-sm" },
              React.createElement("div", { className: "flex items-center justify-between" },
                React.createElement("h3", { className: "text-sm font-semibold text-slate-700" }, "Overhead Trend"),
                React.createElement("span", { className: "text-xs text-slate-500" }, "SG&A % of Revenue")
              ),
              React.createElement("div", { className: "mt-2 h-64" },
                React.createElement(ResponsiveContainer, { width: "100%", height: "100%" },
                  React.createElement(AreaChart, { data: history },
                    React.createElement(CartesianGrid, { strokeDasharray: "3 3" }),
                    React.createElement(XAxis, { dataKey: "month" }),
                    React.createElement(YAxis, { domain: [0,1] }),
                    React.createElement(Tooltip, { formatter: (v)=> formatPct(v) }),
                    React.createElement(Area, { type: "monotone", dataKey: "sgaPct", name: "SG&A %", fillOpacity: 0.15, strokeWidth: 2 })
                  )
                )
              )
            )
          ),

          // Manual Data Entry Panel
          React.createElement("section", { className: "mt-8 rounded-2xl border bg-white p-4 shadow-sm" },
            React.createElement("h3", { className: "text-sm font-semibold text-slate-700" }, "Manual Data Entry"),
            React.createElement("p", { className: "mt-1 text-xs text-slate-500" }, "Update KPI values directly here (percentages as decimals, e.g., 0.53 for 53%)."),
            React.createElement("div", { className: "mt-4 grid gap-4 sm:grid-cols-2 lg:grid-cols-3" },
              Object.entries(sampleKpis).map(([key]) =>
                React.createElement("div", { key, className: "flex items-center justify-between gap-3 rounded-xl border p-3" },
                  React.createElement("label", { className: "text-sm font-medium capitalize text-slate-700" }, key),
                  React.createElement("input", {
                    type: "number",
                    value: kpi[key] ?? "",
                    onChange: (e) => setKpi(prev => ({ ...prev, [key]: Number(e.target.value) })),
                    className: "w-32 rounded-lg border px-2 py-1 text-sm"
                  })
                )
              )
            )
          ),

          // Targets & Settings
          React.createElement("section", { className: "mt-8 rounded-2xl border bg-white p-4 shadow-sm" },
            React.createElement("h3", { className: "text-sm font-semibold text-slate-700" }, "Targets & Settings"),
            React.createElement("div", { className: "mt-4 grid gap-4 sm:grid-cols-2 lg:grid-cols-3" },
              Object.entries(defaultTargets).map(([key]) =>
                React.createElement("div", { key, className: "flex items-center justify-between gap-3 rounded-xl border p-3" },
                  React.createElement("label", { className: "text-sm font-semibold capitalize text-slate-700" }, key),
                  React.createElement("input", {
                    type: "number",
                    value: kpiTargets[key] ?? "",
                    onChange: (e) => setKpiTargets(prev => ({ ...prev, [key]: Number(e.target.value) })),
                    className: "w-32 rounded-lg border px-2 py-1 text-sm"
                  })
                )
              )
            )
          )
        ),

        // Footer
        React.createElement("footer", { className: "mt-10 border-t py-6 text-center text-xs text-slate-500" },
          "Built for Joe's Workspace — forward-looking, no-fluff KPIs. Self‑contained with Save/Load and sharable link.")
      );
    }

    const root = ReactDOM.createRoot(document.getElementById("root"));
    root.render(React.createElement(App));
  </script>
</body>
</html>
